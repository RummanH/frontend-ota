<p-toast />
<p-confirmdialog />

<div class="flex justify-between items-center mb-6 px-4 py-3 bg-white rounded-md shadow-sm border">
    <div class="">
        <h2 class="text-xl font-bold text-gray-800">All Sub User List</h2>
    </div>
    <!-- Right: Create SubUser Button -->
    <button (click)="openCreateDialog()" class="font-bold flex items-center gap-2 bg-[#E50000] hover:bg-[#cc0000] text-white px-5 py-2 rounded-md transition shadow">
        <i class="pi pi-user-plus"></i>
        <span class="">Create New User</span>
    </button>
</div>

<p-table
    [value]="subUserList"
    [loading]="isLoading"
    [paginator]="true"
    [rows]="10"
    stripedRows
    [rowsPerPageOptions]="[10, 20, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [responsiveLayout]="'scroll'"
    [showGridlines]="true"
    class="shadow-sm rounded-lg"
    #dt
    [scrollable]="true"
>
    <ng-template pTemplate="header">
        <tr>
            <th>Full Name</th>
            <th>Login Name</th>
            <th>Email</th>
            <th>Contact No.</th>
            <th>Created Date</th>
            <th>Status</th>
            <th class="text-center">Action</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-user let-rowIndex="rowIndex">
        <tr>
            <td>{{ user.Name }}</td>
            <td>{{ user.UserName }}</td>
            <td>{{ user.UserEmail }}</td>
            <td>{{ user.MobileNo }}</td>
            <td>{{ user.CreateDate | date: 'medium' }}</td>
            <td>
                <div class="flex items-center justify-center gap-3">
                    <p-toggleswitch [(ngModel)]="user.IsActive" (onChange)="toggleStatus(user?.IsActive, user.Id)" />
                </div>
            </td>

            <td class="text-center">
                <p-button icon="pi pi-pen-to-square" class="mr-2" (onClick)="editUser(user)" severity="info" size="small" [rounded]="true" />
            </td>
        </tr>
    </ng-template>
</p-table>

<p-dialog [(visible)]="subUserDialogVisible" [modal]="true" [style]="{ width: '500px' }" [header]="selectedUser ? 'Edit Sub User' : 'Create Sub User'">
    <form [formGroup]="subUserForm" class="p-fluid space-y-4">
        <div>
            <label for="name" class="block mb-1 font-semibold">Full Name</label>
            <input id="name" pInputText formControlName="Name" class="w-full" />
            <small class="text-danger" *ngIf="subUserForm.get('Name')?.invalid && subUserForm.get('Name')?.touched"> Full Name is required. </small>
        </div>

        <div>
            <label for="username" class="block mb-1 font-semibold">Login Name</label>
            <input [readOnly]="isEditMode" [disabled]="isEditMode" id="username" pInputText formControlName="UserName" class="w-full" />
            <small class="text-danger" *ngIf="subUserForm.get('UserName')?.hasError('required') && subUserForm.get('UserName')?.touched"> Login Name is required. </small>
            <small class="text-danger" *ngIf="subUserForm.get('UserName')?.hasError('pattern') && !subUserForm.get('UserName')?.hasError('required')"> Space is not allowed. </small>
        </div>

        <div>
            <label for="password" class="block mb-1 font-semibold">Password</label>
            <input pInputText id="password" formControlName="Password" class="w-full" />
            <small class="text-danger" *ngIf="subUserForm.get('Password')?.hasError('required') && subUserForm.get('Password')?.touched"> Password is required. </small>

            <small class="text-danger" *ngIf="subUserForm.get('Password')?.hasError('pattern') && !subUserForm.get('Password')?.hasError('required')">
                Password must be at least 8 characters and include a letter, number, and special character.
            </small>
        </div>

        <div>
            <label for="email" class="block mb-1 font-semibold">Email</label>
            <input [readOnly]="isEditMode" [disabled]="isEditMode" id="email" type="email" pInputText formControlName="Email" class="w-full" />
            <small class="text-danger" *ngIf="subUserForm.get('Email')?.invalid && subUserForm.get('Email')?.touched"> Valid Email is required. </small>
        </div>

        <div>
            <label for="mobileNo" class="block mb-1 font-semibold">Mobile No.</label>
            <input id="mobileNo" type="tel" pInputText formControlName="MobileNo" class="w-full" />
            <small class="text-danger" *ngIf="subUserForm.get('MobileNo')?.invalid && subUserForm.get('MobileNo')?.touched"> Mobile No is required. </small>
        </div>

        <div [formGroup]="subUserForm" class="bg-white w-full max-w-2xl">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl mb-0 font-semibold text-gray-800">Permissions : Sub-user Access</h2>
                <p-button variant="outlined" class="text-[#E50000]" (click)="toggleAllPermissions()">
                    {{ allPermissionsChecked ? 'Uncheck All' : 'Check All' }}
                </p-button>
            </div>

            <div formGroupName="permissions" class="space-y-5">
                <div
                    *ngFor="let permission of permissionList"
                    class="flex items-start gap-5 bg-gray-50 hover:bg-gray-100 p-5 rounded-xl transition cursor-pointer"
                    (click)="togglePermission(permission.key)"
                    [ngClass]="{
                        'bg-blue-50 border-blue-400 ring-2 ring-blue-400 shadow-lg': getPermissionValue(permission.key),
                        'bg-gray-50 hover:bg-gray-100': !getPermissionValue(permission.key)
                    }"
                >
                    <!-- Icon -->
                    <div class="w-11 h-11 flex items-center justify-center bg-[#E50000] text-[#fff] rounded-full shrink-0">
                        <i [class]="permission.icon"></i>
                    </div>

                    <!-- Label and Description -->
                    <div class="flex-1">
                        <h3 class="text-base font-medium text-gray-800 mb-0">{{ permission.label }}</h3>
                        <p class="text-sm text-gray-500">{{ permission.description }}</p>
                    </div>

                    <!-- Toggle Switch -->
                    <div (click)="$event.stopPropagation()">
                        <p-toggleswitch [formControlName]="permission.key" styleClass="ml-auto custom-toggle"></p-toggleswitch>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <ng-template #footer>
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="subUserDialogVisible = false" />
            <p-button label="Save" icon="pi pi-check" (onClick)="saveSubUser()" [disabled]="subUserForm.invalid" severity="primary" />
        </div>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="filterDialogVisible" [modal]="true" [style]="{ width: '90%', maxWidth: '500px' }" header="Filter Users">
    <ng-template #content>
        <div class="flex flex-col gap-5">
            <!-- Name -->
            <div>
                <label for="filterName" class="block mb-2 font-semibold">Full Name</label>
                <input id="filterName" type="text" pInputText [(ngModel)]="filters.name" class="w-full" />
            </div>

            <!-- Email -->
            <div>
                <label for="filterEmail" class="block mb-2 font-semibold">Email</label>
                <input id="filterEmail" type="email" pInputText [(ngModel)]="filters.email" class="w-full" />
            </div>

            <!-- Mobile Number -->
            <div>
                <label for="filterMobile" class="block mb-2 font-semibold">Contact No.</label>
                <input id="filterMobile" type="text" pInputText [(ngModel)]="filters.mobileNo" class="w-full" />
            </div>

            <!-- Status -->
            <div>
                <label for="filterStatus" class="block mb-2 font-semibold">Status</label>
                <p-select appendTo="body" id="filterStatus" [options]="statusOptions" [(ngModel)]="filters.status" placeholder="Select Status" class="w-full" optionLabel="label" optionValue="value"></p-select>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <div class="flex justify-end gap-2 flex-wrap">
            <p-button label="Clear" icon="pi pi-times" severity="secondary" (click)="clearFilters()" />
            <p-button label="Search" icon="pi pi-search" severity="primary" (click)="applyFilters()" />
        </div>
    </ng-template>
</p-dialog>
