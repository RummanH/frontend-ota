<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button label="Apply Filter" icon="pi pi-filter" severity="secondary" class="mr-2" (onClick)="openFiltering()" />
    </ng-template>

    <!-- <ng-template #end>
        <p-button label="Export" icon="pi pi-upload" severity="secondary" (onClick)="exportCSV()" />
    </ng-template> -->
</p-toolbar>

<p-table
    #dt
    [value]="ticketList"
    [loading]="isFetchingData"
    [scrollable]="true"
    [rowsPerPageOptions]="[5, 10, 25, 50]"
    [paginator]="true"
    [lazyLoadOnInit]="true"
    [lazy]="true"
    (onLazyLoad)="onLazyLoad($event)"
    [totalRecords]="pagination.totalRecord"
    [(first)]="pagination.first"
    [(rows)]="pagination.rows"
    stripedRows
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [showGridlines]="true"
>
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <h5 class="m-0">Retrieve Ticket List</h5>
        </div>
    </ng-template>
    <ng-template #header>
        <tr>
            <th style="min-width: 8rem">Airline</th>
            <th style="min-width: 12rem">Booking ID</th>
            <th style="min-width: 12rem">Ticketed Date</th>
            <th style="min-width: 12rem">Flight Date</th>
            <th style="min-width: 10rem">Airline PNR</th>
            <th style="min-width: 10rem">Sabre PNR</th>
            <th style="min-width: 8rem">Route</th>
            <th style="min-width: 10rem">Total Price</th>
            <th style="min-width: 8rem">No. of Pax</th>
            <th style="min-width: 12rem">Passenger Name</th>
            <th style="min-width: 12rem">Retrieved By</th>
            <th style="min-width: 14rem" alignFrozen="right" pFrozenColumn [frozen]="true">Actions</th>
        </tr>
    </ng-template>
    <ng-template #body let-ticket>
        <tr>
            <td style="min-width: 8rem">
                <img [src]="getSafeUrl(airLogos[ticket.CarrierCode].png)" style="width: 64px" class="rounded" />
            </td>
            <td style="min-width: 12rem">{{ ticket.RefNo }}</td>
            <td style="min-width: 12rem">{{ ticket.TicketingDate | date: 'EEE, dd MMM yyyy' }}</td>
            <td style="min-width: 16rem">{{ ticket.DepartureDate | date: 'EEE, dd MMM yyyy, H:mm a' }}</td>
            <td style="min-width: 10rem">{{ ticket.ConfirmationNo }}</td>
            <td style="min-width: 10rem">{{ ticket.ReservationNo }}</td>
            <td style="min-width: 8rem" [innerHTML]="ticket.Sector"></td>
            <td style="min-width: 10rem">{{ ticket.TotalFare }}</td>
            <td style="min-width: 8rem">{{ ticket.TotalPax }}</td>
            <td style="min-width: 16rem">{{ ticket.LeadPax }}</td>
            <td style="min-width: 12rem">{{ ticket.RetrivedBy }}</td>
            <td alignFrozen="right" pFrozenColumn [frozen]="true">
                <p-button icon="pi pi-ticket" class="mr-2" severity="danger" [rounded]="true" [outlined]="true" (click)="viewTicket(ticket.ReservationNo)" label="View"></p-button>
                <p-button icon="pi pi-file" *ngIf="currentType === 'confirmed' && isShowTab && (isSubUser || !isSubUser)" [rounded]="true" [outlined]="true" (onClick)="openTicketStatusModal(ticket.ReservationNo)" label="Edit"></p-button>
            </td>
        </tr>
    </ng-template>
</p-table>

<p-dialog [(visible)]="searchDialogVisible" [style]="{ width: '90%', maxWidth: '500px' }" header="Search Filters" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-5">
            <!-- Date From -->
            <div>
                <label for="dateFrom" class="block mb-2">Date From</label>
                <p-datepicker appendTo="body" id="dateFrom" [(ngModel)]="searchFilters.dateFrom" dateFormat="yy-mm-dd" showIcon class="w-full" />
            </div>

            <!-- Date To -->
            <div>
                <label for="dateTo" class="block mb-2">Date To</label>
                <p-datepicker appendTo="body" id="dateTo" [(ngModel)]="searchFilters.dateTo" dateFormat="yy-mm-dd" showIcon class="w-full" />
            </div>

            <!-- PNR Number -->
            <div>
                <label for="pnrNumber" class="block mb-2">Airline PNR / Sabre PNR / Booking ID</label>
                <input type="text" id="pnrNumber" pInputText [(ngModel)]="searchFilters.pnrNumber" class="w-full" />
            </div>

            <!-- IGX Number -->
            <!-- <div>
                <label for="igxNumber" class="block font-bold mb-2">Reference No</label>
                <input type="text" id="igxNumber" pInputText [(ngModel)]="searchFilters.igxNumber" class="w-full" />
            </div> -->
        </div>
    </ng-template>

    <ng-template #footer>
        <div class="flex justify-end gap-2 flex-wrap">
            <p-button label="Clear" icon="pi pi-times" text (click)="clearFilters()" />
            <p-button label="Search" icon="pi pi-search" (click)="applyFilters()" />
        </div>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="showTicketStatusModal" [modal]="true" [style]="{ width: '90%', maxWidth: '400px' }" header="Change Status" [contentStyle]="{ padding: '1.5rem' }" [styleClass]="'rounded-xl shadow-lg'">
    <ng-template pTemplate="content">
        <div class="flex flex-col gap-6">
            <div class="grid grid-cols-2 gap-4">
                <div
                    *ngFor="let status of statuses"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl border-2 cursor-pointer transition-all duration-300"
                    [ngClass]="{
                        'border-[#E50000] bg-[#E50000]/10 shadow-md': selectedStatus === status.value,
                        'border-gray-200 hover:border-gray-300 bg-white': selectedStatus !== status.value
                    }"
                    (click)="selectedStatus = status.value"
                >
                    <p-radioButton name="status" [inputId]="status.value" [value]="status.value" [(ngModel)]="selectedStatus" [binary]="true" class="!mt-0"></p-radioButton>

                    <label
                        [for]="status.value"
                        class="cursor-pointer text-sm font-semibold transition-colors"
                        [ngClass]="{
                            'text-[#E50000]': selectedStatus === status.value,
                            'text-gray-800': selectedStatus !== status.value
                        }"
                    >
                        {{ status.label }}
                    </label>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-3 px-4 py-3 border-t border-gray-200">
            <p-button label="Cancel" icon="pi pi-times" (click)="showTicketStatusModal = false" severity="secondary" styleClass="px-4 py-2 text-sm rounded-md"></p-button>
            <p-button
                label="Done"
                icon="pi pi-check"
                (click)="submitTicketStatus()"
                styleClass="px-4 py-2 text-sm rounded-md text-white"
                [style]="{
                    backgroundColor: '#E50000',
                    borderColor: '#E50000'
                }"
            ></p-button>
        </div>
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />
