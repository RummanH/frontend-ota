<!-- Shell -->
<div>
    <p-toast />

    <form (ngSubmit)="searchFlight()" [formGroup]="searchForm" class="bg-white rounded-xl shadow-md p-4 mb-4 hover:shadow-lg">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap gap-3">
                <button type="button" *ngFor="let type of journeyTypes" (click)="onJourneyTypeChange(type.value)"
                    [ngClass]="searchForm.get('journeyType')?.value === type.value ? 'text-white shadow' : 'text-gray-500 border border-gray-200 hover:text-[#E50000] hover:border-[#E50000]'"
                    [ngStyle]="searchForm.get('journeyType')?.value === type.value ? { 'background-color': '#E50000', 'border-color': '#E50000' } : {}"
                    class="flex items-center gap-2 rounded-lg px-5 py-2 text-sm font-medium transition">
                    <span
                        [ngClass]="searchForm.get('journeyType')?.value === type.value ? 'border-2 border-white' : 'border border-gray-400'"
                        [ngStyle]="searchForm.get('journeyType')?.value === type.value ? { 'background-color': '#E50000' } : {}"
                        class="h-4 w-4 rounded-full"></span>

                    {{ type.label }}
                </button>
            </div>

            <div class="flex gap-3">
                <div class="relative inline-block text-left">
                    <!-- Traveller Button -->
                    <button type="button" (click)="toggleShowPaxDropdown()"
                        class="flex w-[150px] gap-0 items-center justify-between rounded-lg bg-red-50 px-5 py-3 text-sm font-semibold text-[#E50000] shadow-sm">
                        <div class="flex gap-2">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024"
                                class="text-lg max-sm:hidden" height="1em" width="1em"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 0 0-80.6 119.5A371.7 371.7 0 0 0 136 901.8a8 8 0 0 0 8 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 0 0 8-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z">
                                </path>
                            </svg>
                            {{ totalTravelars }} Travelers
                        </div>
                        <i class="pi pi-chevron-down"></i>
                    </button>

                    <div *ngIf="showPaxDropdown"
                        class="absolute z-10 mt-2 w-72 rounded-xl bg-white p-4 shadow-xl ring-1 ring-red-100">
                        <!-- Adults -->
                        <div class="mb-4 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold m-0 text-gray-800">Adults</p>
                                <p class="text-xs text-gray-500">12 years & above</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" (click)="adultMinus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">-</button>
                                <span class="w-4 text-center text-sm font-medium text-gray-800">{{ adults }}</span>
                                <button type="button" (click)="adultPlus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">+</button>
                            </div>
                        </div>

                        <!-- Children -->
                        <div class="mb-4 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold m-0 text-gray-800">Children</p>
                                <p class="text-xs text-gray-500">From 5 to under 12</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" (click)="childrenMinus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">-</button>
                                <span class="w-4 text-center text-sm font-medium text-gray-800">{{ children }}</span>
                                <button type="button" (click)="childrenPlus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">+</button>
                            </div>
                        </div>

                        <!-- Kids -->
                        <div class="mb-4 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold m-0 text-gray-800">Kids</p>
                                <p class="text-xs text-gray-500">From 2 to under 5</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" (click)="kidsMinus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">-</button>
                                <span class="w-4 text-center text-sm font-medium text-gray-800">{{ kids }}</span>
                                <button type="button" (click)="kidsPlus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">+</button>
                            </div>
                        </div>

                        <!-- Infants -->
                        <div class="mb-4 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold m-0 text-gray-800">Infants</p>
                                <p class="text-xs text-gray-500">Under 2 years</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" (click)="infantsMinus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">-</button>
                                <span class="w-4 text-center text-sm font-medium text-gray-800">{{ infants }}</span>
                                <button type="button" (click)="infantsPlus()"
                                    class="w-8 h-8 rounded-full border font-bold text-xl border-gray-300 text-gray-700 hover:border-[#E50000] hover:text-[#E50000] hover:bg-red-50 transition">+</button>
                            </div>
                        </div>

                        <!-- Done Button -->
                        <div class="mt-2">
                            <button type="button" (click)="toggleShowPaxDropdown()"
                                class="w-full rounded-md border border-[#E50000] bg-white px-4 py-2 text-sm font-semibold text-[#E50000] hover:bg-red-50 transition">Done</button>
                        </div>
                    </div>
                </div>

                <div class="relative w-[200px]">
                    <button type="button" (click)="toggleClassDropdown()"
                        class="flex w-full items-center justify-between rounded-lg gap-0 bg-red-50 px-5 py-3 text-sm font-semibold text-[#E50000]">
                        <div class="flex gap-2">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                class="text-lg max-sm:hidden" height="1em" width="1em"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill="none" d="M0 0h24v24H0V0z"></path>
                                <path
                                    d="M7.59 5.41c-.78-.78-.78-2.05 0-2.83s2.05-.78 2.83 0 .78 2.05 0 2.83c-.79.79-2.05.79-2.83 0zM6 16V7H4v9c0 2.76 2.24 5 5 5h6v-2H9c-1.66 0-3-1.34-3-3zm14 4.07L14.93 15H11.5v-3.68c1.4 1.15 3.6 2.16 5.5 2.16v-2.16c-1.66.02-3.61-.87-4.67-2.04l-1.4-1.55c-.19-.21-.43-.38-.69-.5-.29-.14-.62-.23-.96-.23h-.03C8.01 7 7 8.01 7 9.25V15c0 1.66 1.34 3 3 3h5.07l3.5 3.5L20 20.07z">
                                </path>
                            </svg>
                            {{ searchForm.get('classType')?.value?.name || 'Select Class Type' }}
                        </div>
                        <i class="pi pi-chevron-down"></i>
                    </button>
                    <div *ngIf="dropdownOpen"
                        class="absolute z-50 mt-1 w-full rounded-lg border border-gray-200 bg-white shadow-md">
                        <div *ngFor="let type of classTypes" (click)="selectClassType(type)"
                            class="cursor-pointer px-5 py-3 text-sm text-gray-700 hover:bg-sky-100 hover:text-[#E50000]">
                            {{ type.name }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div formArrayName="segments">
            <div *ngFor="let segment of segments.controls; let i = index" [formGroupName]="i" class="mt-5 grid gap-4"
                [ngClass]="searchForm.get('journeyType')?.value !== 2 ? 'grid-cols-3 sm:grid-cols-3 md:grid-cols-3 xl:grid-cols-3' : 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4'">
                <!-- Origin Input -->

                <div class="w-full" (clickOutside)="onClickedOutside(segment, 'showOrigin')">
                    <div *ngIf="!segment.get('uiState.showOrigin')?.value"
                        (click)="onTriggerClick($event, i, 'showOrigin')"
                        class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3 cursor-pointer w-full">
                        <div class="text-xl font-semibold text-gray-800">{{ segment.get('origin')?.value?.code }}</div>
                        <div class="h-8 w-px bg-gray-300"></div>
                        <div class="min-w-0 leading-tight">
                            <p class="text-sm font-semibold text-gray-800 mb-0">{{ segment.get('origin')?.value?.city ||
                                '' }}</p>
                            <p class="text-xs text-gray-500 truncate">{{ segment.get('origin')?.value?.name || '' }}</p>
                        </div>
                    </div>

                    <div *ngIf="segment.get('uiState.showOrigin')?.value"
                        class="rounded-lg border border-gray-300 px-4 py-3 w-full flex items-center gap-3">
                        <p-autocomplete (click)="stopEventPropagation($event)" #originAuto appendTo="body"
                            formControlName="origin" [suggestions]="airportList"
                            (completeMethod)="searchCity($event.query)" optionLabel="name" [field]="'city'"
                            showClear="true" (onSelect)="toggleDropdown(i, 'showOrigin')" [styleClass]="'w-full'"
                            class="custom-auto-complete border-none outline-none w-full text-sm text-gray-800"
                            [panelStyleClass]="'z-50'" placeholder="Flying from Airport/City">
                            <ng-template let-country #item>
                                <div class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3 w-full">
                                    <div class="text-xl font-semibold text-gray-800">{{ country.code }}</div>
                                    <div class="h-8 w-px bg-gray-300"></div>
                                    <div class="min-w-0 leading-tight">
                                        <p class="text-sm font-semibold text-gray-800 mb-0">{{ country.city }}</p>
                                        <p class="text-xs text-gray-500 truncate">{{ country.name }}</p>
                                    </div>
                                </div>
                            </ng-template>
                        </p-autocomplete>
                    </div>
                </div>

                <!-- Destination Input -->
                <div class="w-full" (clickOutside)="onClickedOutside(segment, 'showDestination')">
                    <div *ngIf="!segment.get('uiState.showDestination')?.value"
                        (click)="onTriggerClick($event, i, 'showDestination')"
                        class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3 cursor-pointer w-full">
                        <div class="text-xl font-semibold text-gray-800">{{ segment.get('destination')?.value?.code }}
                        </div>
                        <div class="h-8 w-px bg-gray-300"></div>
                        <div class="min-w-0 leading-tight">
                            <p class="text-sm font-semibold text-gray-800 mb-0">{{
                                segment.get('destination')?.value?.city }}</p>
                            <p class="text-xs text-gray-500 truncate">{{ segment.get('destination')?.value?.name }}</p>
                        </div>
                    </div>

                    <div *ngIf="segment.get('uiState.showDestination')?.value"
                        class="rounded-lg border border-gray-300 px-4 py-3 w-full flex items-center gap-3">
                        <p-autocomplete (click)="stopEventPropagation($event)" #returnAuto formControlName="destination"
                            [suggestions]="airportList" (completeMethod)="searchCity($event.query)" optionLabel="name"
                            [field]="'city'" showClear="true" (onSelect)="toggleDropdown(i, 'showDestination')"
                            [styleClass]="'w-full'"
                            class="p-autocomplete-panel custom-auto-complete border-none outline-none w-full text-sm text-gray-800"
                            [panelStyleClass]="'z-50'" placeholder="Flying from Airport/City">
                            <ng-template let-country #item>
                                <div class="flex items-center gap-1 rounded-lg border border-gray-300 px-4 py-3 w-full">
                                    <div class="text-xl font-semibold text-gray-800">{{ country.code }}</div>
                                    <div class="h-8 w-px bg-gray-300"></div>
                                    <div class="min-w-0 leading-tight">
                                        <p class="text-sm font-semibold text-gray-800 mb-0">{{ country.city }}</p>
                                        <p class="text-xs text-gray-500 truncate">{{ country.name }}</p>
                                    </div>
                                </div>
                            </ng-template>
                        </p-autocomplete>
                    </div>
                </div>

                <!-- Departure Date -->
                <div class="w-full">
                    <div class="grid grid-cols-6 gap-2 items-center">
                        <div [ngClass]="searchForm.get('journeyType')?.value !== 2 ? 'col-span-5' : 'col-span-6'">
                            <div *ngIf="segment.get('uiState.showDeparture')?.value"
                                class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3 w-full">
                                <p-datepicker [attr.data-index]="i" formControlName="departureDate"
                                    (onClickOutside)="toggleDropdown(i, 'showDeparture')" class="custom-datepicker"
                                    appendTo="body" #originDatepicker (onSelect)="toggleDropdown(i, 'showDeparture')" />
                            </div>

                            <div (click)="toggleDropdown(i, 'showDeparture')"
                                *ngIf="!segment.get('uiState.showDeparture')?.value"
                                class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3 w-full cursor-pointer">
                                <div class="text-xl font-semibold text-gray-800">{{ segment.get('departureDate')?.value
                                    | date: 'dd' }}</div>
                                <div class="h-8 w-px bg-gray-300"></div>
                                <div class="min-w-0 leading-tight">
                                    <p class="text-sm font-semibold text-gray-800 mb-0">{{
                                        segment.get('departureDate')?.value | date: 'MMMM' }}</p>
                                    <p class="text-xs text-gray-500">{{ segment.get('departureDate')?.value | date:
                                        'EEEE, y' }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Close Button (1 part) -->
                        <div class="flex justify-center items-center" *ngIf="segmentsLength > 1">
                            <button type="button" (click)="removeSegment(i)"
                                class="h-8 w-8 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center justify-center"><i
                                    class="pi pi-times text-sm"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Return Date -->
                <div class="w-full" *ngIf="searchForm.get('journeyType')?.value === 2">
                    <div *ngIf="segment.get('uiState.showReturn')?.value"
                        class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3">
                        <p-datepicker [attr.data-index]="i" formControlName="returnDate"
                            (onClickOutside)="toggleDropdown(i, 'showReturn')" class="custom-datepicker" appendTo="body"
                            #returnDatepicker (onSelect)="toggleDropdown(i, 'showReturn')" />
                    </div>

                    <div [ngClass]="{
                            'opacity-50 pointer-events-none cursor-not-allowed': searchForm.get('journeyType')?.value === 1,
                            'opacity-100': searchForm.get('journeyType')?.value !== 1
                        }" (click)="toggleDropdown(i, 'showReturn')" *ngIf="!segment.get('uiState.showReturn')?.value"
                        class="flex items-center gap-3 rounded-lg border border-gray-300 px-4 py-3 cursor-pointer">
                        <div class="text-xl font-semibold text-gray-800">{{ segment.get('returnDate')?.value | date:
                            'dd' }}</div>
                        <div class="h-8 w-px bg-gray-300"></div>
                        <div class="min-w-0 leading-tight">
                            <p class="text-sm font-semibold text-gray-800 mb-0">{{ segment.get('returnDate')?.value |
                                date: 'MMMM' }}</p>
                            <p class="text-xs text-gray-500">
                                {{
                                segment.get('returnDate')?.value
                                | date
                                : 'EEEE,
                                y'
                                }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5 grid gap-4"
            [ngClass]="searchForm.get('journeyType')?.value !== 2 ? 'grid-cols-3 sm:grid-cols-3 md:grid-cols-3 xl:grid-cols-3' : 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4'">
            <button [disabled]="segmentsLength === 6" (click)="addSegment()"
                *ngIf="searchForm.get('journeyType')?.value === 3" pButton pRipple type="button"
                class="p-button-outlined flex items-center text-blue-500 font-medium">
                <i class="pi pi-plus mr-2"></i>
                Add More Flight
            </button>

            <div class="w-full flex items-center gap-3">
                <input type="text" formControlName="carriersCode"
                    oninput="this.value = this.value.toUpperCase().replace(/[^a-zA-Z0-9 /]/g, '').trim().substring(0, 11)"
                    (keyup)="onInputChange($event)" placeholder="Example: BG/EK/TK/QR"
                    class="w-full font-bold rounded-lg border border-gray-300 px-4 py-5 text-sm text-gray-700 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" />
            </div>

            <div class="w-full flex items-center gap-3">
                <button
                    class="flex h-[54px] w-[54px] items-center justify-center rounded-lg bg-[#E50000] transition hover:bg-[#b70000]">
                    <i class="pi pi-search text-xl text-white"></i>
                </button>
            </div>
        </div>
    </form>
</div>
